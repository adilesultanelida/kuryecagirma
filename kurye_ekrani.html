<script>
  const ding = new Audio("https://www.soundjay.com/button/beep-07.wav");
  const statusText = document.getElementById("status");
  const countdownText = document.getElementById("countdown");
  let lastPing = null;
  let countdownInterval = null;
  let countdownSeconds = 60;

  // Tarayıcıdan bildirim izni iste
  if (Notification.permission !== "granted") {
    Notification.requestPermission();
  }

  function startCountdown() {
    countdownSeconds = 60;
    countdownText.innerText = `Kalan: ${countdownSeconds} sn`;
    countdownInterval = setInterval(() => {
      countdownSeconds--;
      countdownText.innerText = `Kalan: ${countdownSeconds} sn`;

      if (countdownSeconds <= 0) {
        clearInterval(countdownInterval);
        statusText.innerText = "Hazır, çağrı bekleniyor...";
        countdownText.innerText = "";
      }
    }, 1000);
  }

  async function checkPing() {
    try {
      const res = await fetch("/api/ping.json");
      const data = await res.json();

      if (lastPing !== data.time) {
        lastPing = data.time;
        statusText.innerText = "📢 Kurye çağrıldı!";
        
        // Bildirim gönder
        if (Notification.permission === "granted") {
          new Notification("Kurye Çağrısı", { body: "Müdür seni çağırdı!", icon: "https://cdn-icons-png.flaticon.com/512/1827/1827349.png" });
        }

        // Ses çal (mobilde etkileşimli değilse çalmaz)
        ding.play().catch(() => {});

        // Sayaç başlat
        if (countdownInterval) clearInterval(countdownInterval);
        startCountdown();
      }

    } catch {
      statusText.innerText = "❌ Bağlantı hatası!";
      countdownText.innerText = "";
    }
  }

  setInterval(checkPing, 3000);
</script>
